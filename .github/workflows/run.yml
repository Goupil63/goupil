name: Vinted Bot

on:
  workflow_dispatch:  # Lancement manuel
  schedule:
    - cron: "*/5 * * * *"  # Toutes les 5 minutes

concurrency:
  group: vinted-bot
  cancel-in-progress: false  # Laisser chaque run se terminer normalement

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.10

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run scraper with auto-exit
        env:
          GH_PAT1: ${{ secrets.GH_PAT1 }}
          VINTED_URL: ${{ secrets.VINTED_URL }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          echo "üöÄ Lancement du scraping..."
          end=$((SECONDS+270))  # ‚è± 4m30 ‚Üí finit avant le prochain run

          while [ $SECONDS -lt $end ]; do
            echo "üîç Nouvelle analyse..."
            python main.py  # ton script complet avec webhook, json, etc.

            sleep $((RANDOM % 120 + 180))  # d√©lai al√©atoire 180‚Äì300s
          done

          echo "‚úÖ Run termin√© proprement avant relance"
